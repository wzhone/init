name: Smoke CI

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]

jobs:
  rocky:
    name: Rocky ${{ matrix.version }} tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        version: ["8", "9"]
    container:
      image: rockylinux/rockylinux:${{ matrix.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install minimal dependencies
        run: |
          set -euxo pipefail
          dnf -y install sudo iproute iputils ncurses

      - name: Install ShellCheck
        run: |
          set -euxo pipefail
          # Install EPEL repository for ShellCheck
          dnf -y install epel-release
          dnf -y install ShellCheck

      - name: ShellCheck static analysis
        run: |
          set -euxo pipefail

          # Run ShellCheck on the main script
          shellcheck -x rocky.sh

      - name: Run pre_check
        run: |
          set -euxo pipefail
          printf "\n" | bash ./rocky.sh pre_check

  alpine:
    name: Alpine ${{ matrix.version }} tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        version: ["3.20", "3.21", "3.22", "3.23"]
    container:
      image: alpine:${{ matrix.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install minimal dependencies
        run: |
          set -euxo pipefail
          apk add --no-cache bash curl iputils openrc shellcheck

      - name: ShellCheck static analysis
        run: |
          set -euxo pipefail
          shellcheck -x alpine.sh

      - name: Test script basic functionality
        run: |
          set -euxo pipefail
          # 15=系统预检查, 第二个换行=返回菜单, 0=退出
          printf "15\n\n0\n" | bash ./alpine.sh
