name: Smoke CI

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]

jobs:
  rocky:
    name: Rocky ${{ matrix.version }} tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        version: ["8", "9"]
    container:
      image: rockylinux/rockylinux:${{ matrix.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install minimal dependencies
        run: |
          set -euxo pipefail
          dnf -y install sudo iproute iputils ncurses

      - name: Install ShellCheck
        run: |
          set -euxo pipefail
          # Install EPEL repository for ShellCheck
          dnf -y install epel-release
          dnf -y install ShellCheck

      - name: ShellCheck static analysis
        run: |
          set -euxo pipefail

          # Run ShellCheck on the main script
          shellcheck -x rocky.sh

      - name: Test script basic functionality
        run: |
          set -euxo pipefail
          # Test 1: Script exits without error when selecting 0
          printf "\n0\n" | bash ./rocky.sh

          # Test 2: Pre-check runs successfully (17 option)
          printf "\n17\n\n\n0\n" | bash ./rocky.sh

      - name: Test basic package installation (option 5)
        run: |
          set -euxo pipefail
          # Test basic packages installation in automated way
          printf "\n5\n\n0\n" | timeout 600 bash ./rocky.sh

          # Verify some basic packages are available
          which git
          which vim
          which tar

  alpine:
    name: Alpine ${{ matrix.version }} tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        version: ["3.20", "3.21", "3.22", "3.23"]
    container:
      image: alpine:${{ matrix.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install minimal dependencies
        run: |
          set -euxo pipefail
          apk add --no-cache bash curl iputils openrc shellcheck

      - name: ShellCheck static analysis
        run: |
          set -euxo pipefail
          shellcheck -x alpine.sh

      - name: Test script basic functionality
        run: |
          set -euxo pipefail
          # Test 1: Script exits without error when selecting 0
          printf "\n0\n" | bash ./alpine.sh
