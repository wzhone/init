name: Smoke CI

on:
  push:
    branches: ["master"]

jobs:
  rocky:
    name: Rocky ${{ matrix.version }} tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        version: ["8", "9", "10"]
    container:
      image: rockylinux/rockylinux:${{ matrix.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install minimal dependencies
        run: |
          set -euxo pipefail
          dnf -y install sudo iproute iputils

      - name: Install ShellCheck
        run: |
          set -euxo pipefail
          # Install EPEL repository for ShellCheck
          dnf -y install epel-release
          dnf -y install ShellCheck

      - name: ShellCheck static analysis
        run: |
          set -euxo pipefail

          # Run ShellCheck on the main script
          shellcheck -x -e SC1091 init.sh

      - name: Test script basic functionality
        run: |
          set -euxo pipefail
          # Test 1: Script exits without error when selecting 0
          printf "\n0\n" | bash ./init.sh

          # Test 2: Pre-check runs successfully (17 option)
          printf "\n17\n\n\n0\n" | bash ./init.sh

      - name: Test basic package installation (option 5)
        run: |
          set -euxo pipefail
          # Test basic packages installation in automated way
          printf "\n5\n\n0\n" | timeout 300 bash ./init.sh || true

          # Verify some basic packages are available
          which git || echo "Git not installed"
          which vim || echo "Vim not installed"
          which tar || echo "Tar not installed"